@model List<PantryManagementSystem.Models.DTO.MyOrderDTO>
@inject IHttpContextAccessor HttpContextAccessor
@using PantryManagementSystem.Models.Enums

@{
    ViewData["Title"] = "My Orders";
    var user = HttpContextAccessor.HttpContext?.User;
    var isStaff = user.IsInRole("Staff");

    var pendingOrders = Model.Where(o => o.Status == "Pending").ToList();
    var approvedOrders = Model.Where(o => o.Status == "Approved").ToList();
    var deniedOrders = Model.Where(o => o.Status == "Denied").ToList();
    var issuedOrders = Model.Where(o => o.Status == "Issued").ToList();
}

<div class="container container-custom my-5">
    <div class="row justify-content-center">
        <div class="col-md-11">
            <div class="card shadow-sm card-custom">
                <!-- Card Header -->
                <div class="card-header text-white text-center mb-3"
                     style="background: linear-gradient(135deg, #6a11cb, #2575fc); border-radius: 12px 12px 0 0;">
                    <h3>My Orders</h3>
                </div>

                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success">@TempData["Success"]</div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger">@TempData["Error"]</div>
                    }

                    @if (isStaff)
                    {
                        <!-- ================= Staff: All Orders ================= -->
                        <h5 class="fw-bold mb-3">All Orders (Staff)</h5>
                        <table class="table table-hover align-middle text-center">
                            <thead class="table-dark">
                                <tr>
                                    <th>Order Id</th>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Status</th>
                                    <th>Req Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!Model.Any())
                                {
                                    <tr>
                                        <td colspan="6" class="text-muted">No orders available.</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var order in Model)
                                    {
                                        <tr>
                                            <td>@order.Id</td>
                                            <td>@order.PantryItemName</td>
                                            <td>@order.Quantity</td>
                                            <td>
                                                @if (order.Status == "Pending")
                                                {
                                                    <span class="badge bg-warning text-dark">Pending</span>
                                                }
                                                else if (order.Status == "Approved")
                                                {
                                                    <span class="badge bg-success">Approved</span>
                                                }
                                                else if (order.Status == "Denied")
                                                {
                                                    <span class="badge bg-danger">Denied</span>
                                                }
                                                else if (order.Status == "Issued")
                                                {
                                                    <span class="badge bg-primary">Issued</span>
                                                }
                                            </td>
                                            <td>@order.RequestDate.ToString("dd-MMM-yyyy")</td>
                                            <td>
                                                @if (order.Status == "Pending")
                                                {
                                                    <form asp-controller="Order" asp-action="Approve" method="post" class="d-inline">
                                                        <input type="hidden" name="orderId" value="@order.Id" />
                                                        <button type="submit" class="btn btn-success btn-sm">Approve</button>
                                                    </form>
                                                    <form asp-controller="Order" asp-action="Deny" method="post" class="d-inline">
                                                        <input type="hidden" name="orderId" value="@order.Id" />
                                                        <button type="submit" class="btn btn-danger btn-sm">Deny</button>
                                                    </form>
                                                }
                                                else if (order.Status == "Approved")
                                                {
                                                    <form asp-controller="Order" asp-action="Issue" method="post" class="d-inline">
                                                        <input type="hidden" name="orderId" value="@order.Id" />
                                                        <button type="submit" class="btn btn-primary btn-sm">Issue</button>
                                                    </form>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <!-- ================= Normal User: Orders by Status ================= -->
                        <div class="row">
                            <!-- Pending -->
                            <div class="col-md-6 mb-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-warning text-dark fw-bold">Pending Orders</div>
                                    <div class="card-body p-0">
                                        @if (!pendingOrders.Any())
                                        {
                                            <p class="p-3 mb-0 text-muted">No pending orders.</p>
                                        }
                                        else
                                        {
                                            <table class="table table-striped table-hover mb-0">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Order Id</th>
                                                        <th>Item</th>
                                                        <th>Qty</th>
                                                        <th>Req Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var order in pendingOrders)
                                                    {
                                                        <tr>
                                                            <td>@order.Id</td>
                                                            <td>@order.PantryItemName</td>
                                                            <td>@order.Quantity</td>
                                                            <td>@order.RequestDate.ToString("dd-MMM-yyyy")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Approved -->
                            <div class="col-md-6 mb-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-success text-white fw-bold">Approved Orders</div>
                                    <div class="card-body p-0">
                                        @if (!approvedOrders.Any())
                                        {
                                            <p class="p-3 mb-0 text-muted">No approved orders.</p>
                                        }
                                        else
                                        {
                                            <table class="table table-striped table-hover mb-0">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Order Id</th>
                                                        <th>Item</th>
                                                        <th>Qty</th>
                                                        <th>Req Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var order in approvedOrders)
                                                    {
                                                        <tr>
                                                            <td>@order.Id</td>
                                                            <td>@order.PantryItemName</td>
                                                            <td>@order.Quantity</td>
                                                            <td>@order.RequestDate.ToString("dd-MMM-yyyy")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div> <!-- card-body -->
            </div> <!-- card -->
        </div> <!-- col -->
    </div> <!-- row -->
</div>